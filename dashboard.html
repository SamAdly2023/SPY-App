{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/vis-network/styles/vis-network.min.css">
<style>
    #resultMap { 
        border: var(--glass-border); 
        height: 650px; 
        margin-top: 20px; 
        background: rgba(0,0,0,0.2); 
        border-radius: 16px; 
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    #results { 
        background: rgba(0,0,0,0.2); 
        padding: 15px; 
        border-radius: 10px; 
        max-height: 400px; 
        overflow: auto; 
        color: #eee; 
        font-size: 14px; 
    }
    .tooltip-custom { 
        position: absolute; 
        background: rgba(15, 20, 35, 0.95); 
        color: #fff; 
        padding: 15px; 
        border-radius: 12px; 
        max-width: 350px; 
        font-size: 14px; 
        display: none; 
        z-index: 1000; 
        box-shadow: 0 0 20px rgba(0, 97, 255, 0.3);
        border: 1px solid #0061ff;
        backdrop-filter: blur(5px);
    }
    .result-card { 
        background: rgba(255,255,255,0.03); 
        padding: 15px; 
        margin-bottom: 15px; 
        border-radius: 12px; 
        display: flex; 
        align-items: center; 
        gap: 15px; 
        border: 1px solid rgba(255,255,255,0.05); 
        transition: 0.3s;
    }
    .result-card:hover {
        background: rgba(255,255,255,0.07);
        border-color: rgba(0, 97, 255, 0.3);
    }
    .result-card img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #0061ff; }
    .result-card .info { flex: 1; }
    .result-card .info .title { font-weight: bold; color: #60efff; font-family: "Orbitron", sans-serif; letter-spacing: 0.5px; }
    .result-card .info .link { font-size: 12px; color: #0061ff; word-break: break-all; text-decoration: none; }
    .result-card .info .link:hover { text-decoration: underline; }
    .result-card .info .type { font-size: 11px; color: #fff; background: linear-gradient(45deg, #0061ff, #00d2ff); padding: 3px 8px; border-radius: 20px; margin-top: 6px; display: inline-block; font-weight: bold; }
    
    .nav-tabs { border-bottom: 1px solid rgba(255,255,255,0.1); }
    .nav-link { color: #94a3b8; border: none; font-family: "Orbitron", sans-serif; letter-spacing: 1px; }
    .nav-link:hover { color: #fff; }
    .nav-link.active { 
        color: #fff !important; 
        background: transparent !important; 
        border-bottom: 3px solid #0061ff !important; 
        font-weight: bold;
    }
    
    /* Result Card Styles from origenal.html */
    .result-card { background: rgba(255,255,255,0.05); padding:10px; margin-bottom:10px; border-radius:10px; display:flex; align-items:center; gap:10px; border:1px solid rgba(255,255,255,0.1); transition: 0.3s; }
    .result-card:hover { background: rgba(255,255,255,0.1); }
    .result-card img { width:50px; height:50px; border-radius:50%; object-fit:cover; }
    .result-card .info { flex:1; }
    .result-card .info .title { font-weight:bold; color:#ffc107; }
    .result-card .info .link { font-size:12px; color:#6cf; word-break:break-all; text-decoration: none; }
    .result-card .info .type { font-size:12px; color:#fff; background: rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; margin-top:4px; display:inline-block; }
    .result-card button { background:#ff9800; border:none; color:#000; padding:3px 6px; border-radius:6px; cursor:pointer; font-size: 12px; font-weight: bold; }
    .result-card button:hover { background:#ffc107; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-uppercase m-0"><i class="fa-solid fa-gauge-high me-2"></i> Dashboard</h2>
        {% if user.is_admin %}
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="adminSwitch" onchange="window.location.href='{{ url_for('admin_dashboard') }}'">
            <label class="form-check-label text-warning fw-bold" for="adminSwitch">Switch to Admin</label>
        </div>
        {% endif %}
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card-custom">
                <form id="searchForm">
                    <div class="input-group mb-3">
                        <input type="text" id="queryInput" class="form-control" placeholder="Enter person, username, or company name..." required>
                        <button class="btn btn-primary-custom" type="submit"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
                    </div>
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <label class="text-muted">Search Depth:</label>
                        <select id="depthSelect" class="form-select" style="width: auto;">
                            <option value="1">1 Page</option>
                            <option value="2" selected>2 Pages</option>
                            <option value="3">3 Pages</option>
                            <option value="5">5 Pages</option>
                        </select>
                        <span class="text-info ms-auto"><i class="fa-solid fa-coins"></i> Cost: 1 Credit</span>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph" type="button" role="tab">Graph View</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">List View</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="google-tab" data-bs-toggle="tab" data-bs-target="#google" type="button" role="tab">Google Search</button>
        </li>
    </ul>
    
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="graph" role="tabpanel">
            <div id="resultMap"></div>
        </div>
        <div class="tab-pane fade" id="list" role="tabpanel">
            <div class="card-custom">
                <h4 class="mb-3"><i class="fa-solid fa-list"></i> Raw Results</h4>
                <div id="results"></div>
            </div>
        </div>
        <div class="tab-pane fade" id="google" role="tabpanel">
            <div class="card-custom">
                <h4 class="mb-3"><i class="fa-brands fa-google"></i> Google Custom Search</h4>
                <!-- Custom CSS to style Google CSE for dark mode and fix layout -->
                <style>
                    .gsc-control-cse {
                        background-color: transparent !important;
                        border: none !important;
                        padding: 0 !important;
                    }
                    .gsc-search-button-v2 {
                        background-color: #0061ff !important;
                        border-radius: 5px !important;
                    }
                    .gsc-input-box {
                        background: rgba(255,255,255,0.1) !important;
                        border: 1px solid rgba(255,255,255,0.2) !important;
                        border-radius: 5px !important;
                    }
                    .gsc-input {
                        background: transparent !important;
                        color: #fff !important;
                        padding-right: 0 !important;
                    }
                    .gs-title {
                        text-decoration: none !important;
                    }
                    .gs-title a {
                        color: #60efff !important;
                        font-weight: bold !important;
                    }
                    .gs-snippet {
                        color: #ccc !important;
                    }
                    .gsc-url-top, .gsc-url-bottom {
                        color: #28a745 !important;
                    }
                    .gsc-webResult.gsc-result {
                        background-color: transparent !important;
                        border-bottom: 1px solid rgba(255,255,255,0.1) !important;
                        padding: 15px 0 !important;
                    }
                    .gsc-results-wrapper-overlay {
                        position: static !important;
                        width: 100% !important;
                        box-shadow: none !important;
                        background: transparent !important;
                        border: none !important;
                        height: auto !important;
                        top: auto !important;
                        left: auto !important;
                        z-index: auto !important;
                    }
                    .gsc-modal-background-image {
                        display: none !important;
                    }
                    .gsc-results-close-btn {
                        display: none !important;
                    }
                    .gsc-overflow-hidden {
                        overflow: auto !important;
                    }
                </style>
                <script async src="https://cse.google.com/cse.js?cx=452d685a5b79d4c2e"></script>
                <div class="gcse-search" data-linkTarget="_blank"></div>
            </div>
        </div>
    </div>

</div>

<div id="tooltip" class="tooltip-custom"></div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
const tooltip = document.getElementById("tooltip");
let currentData = [];

document.getElementById("searchForm").onsubmit = async function(e){
    e.preventDefault();
    
    const query = document.getElementById("queryInput").value;
    const depth = document.getElementById("depthSelect").value;
    
    // Show loading state
    const btn = this.querySelector("button");
    const originalText = btn.innerHTML;
    btn.innerHTML = "<i class=\"fa-solid fa-spinner fa-spin\"></i> Searching...";
    btn.disabled = true;
    
    let form = new FormData();
    form.append("query", query);
    form.append("depth", depth);

    try {
        let response = await fetch("/search", { method: "POST", body: form });
        
        if (response.status === 403) {
            alert("Insufficient credits! Please top up in your profile.");
            window.location.href = "{{ url_for("profile") }}";
            return;
        }
        
        let data = await response.json();
        currentData = data;
        
        renderGraph(data);
        renderList(data);
        
    } catch (error) {
        console.error("Error:", error);
        alert("An error occurred during search.");
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
};

function renderList(data) {
    const container = document.getElementById("results");
    container.innerHTML = "";

    if (!data || data.length === 0) {
        container.innerHTML = "<p class=\"text-center text-muted\">No results found.</p>";
        return;
    }

    const types = {};
    data.forEach(result => {
        if (!result.type) result.type = "Websites";
        if (!types[result.type]) types[result.type] = [];
        types[result.type].push(result);
    });

    for (const type in types) {
        // Optional: Add a header for each type section in the list
        // const typeHeader = document.createElement("h5");
        // typeHeader.className = "text-info mt-3 mb-2";
        // typeHeader.textContent = type;
        // container.appendChild(typeHeader);

        types[type].forEach(result => {
            const card = document.createElement("div");
            card.className = "result-card";

            const img = document.createElement("img");
            img.src = result.image || "https://cdn-icons-png.flaticon.com/512/565/565547.png";
            img.onerror = function() { this.src = "https://cdn-icons-png.flaticon.com/512/565/565547.png"; }; // Fallback if image fails

            const info = document.createElement("div");
            info.className = "info";
            info.innerHTML = `
                <div class="title">${result.title}</div>
                <a href="${result.link}" target="_blank" class="link">${result.link}</a>
                <div class="type">${result.type}</div>
            `;

            const btn = document.createElement("button");
            btn.textContent = "Details";
            btn.onclick = () => alert(`Title: ${result.title}\nLink: ${result.link}\nType: ${result.type}`);

            card.appendChild(img);
            card.appendChild(info);
            card.appendChild(btn);
            container.appendChild(card);
        });
    }
}

function renderGraph(data) {
    const queryName = document.getElementById("queryInput").value;
    
    if (!data || data.length === 0) {
        document.getElementById("resultMap").innerHTML =
        "<h3 class='text-center mt-5 text-danger'>No results to map</h3>";
        return;
    }

    // Ensure type exists
    data = data.map(r => {
        if (!r.type || r.type === "" || r.type === null) r.type = "Websites";
        return r;
    });

    let nodes = [], edges = [], nid = 2;

    // Central Node
    nodes.push({
        id: 1,
        label: queryName,
        shape: "box",
        color: "#ffc107",
        font: { color: "#000", size: 18, face: "Orbitron" },
        title: "Search Query"
    });

    const typeGroups = {};
    data.forEach(r => {
        if (!typeGroups[r.type]) typeGroups[r.type] = [];
        typeGroups[r.type].push(r);
    });

    const icons = {
        "Twitter": ["#1DA1F2", "https://cdn-icons-png.flaticon.com/512/733/733579.png"],
        "Facebook": ["#4267B2", "https://cdn-icons-png.flaticon.com/512/733/733547.png"],
        "Instagram": ["#E1306C", "https://cdn-icons-png.flaticon.com/512/2111/2111463.png"],
        "YouTube": ["#FF0000", "https://cdn-icons-png.flaticon.com/512/1384/1384060.png"],
        "Telegram": ["#0088cc", "https://cdn-icons-png.flaticon.com/512/2111/2111646.png"],
        "LinkedIn": ["#0077B5", "https://cdn-icons-png.flaticon.com/512/174/174857.png"],
        "WhatsApp": ["#25D366", "https://cdn-icons-png.flaticon.com/512/733/733585.png"],
        "GitHub": ["#333", "https://cdn-icons-png.flaticon.com/512/733/733553.png"],
        "Reddit": ["#FF4500", "https://cdn-icons-png.flaticon.com/512/2111/2111581.png"],
        "Medium": ["#00ab6c", "https://cdn-icons-png.flaticon.com/512/2111/2111504.png"],
        "StackOverflow": ["#f48024", "https://cdn-icons-png.flaticon.com/512/2111/2111628.png"],
        "Pinterest": ["#bd081c", "https://cdn-icons-png.flaticon.com/512/2111/2111432.png"],
        "TikTok": ["#69C9D0", "https://cdn-icons-png.flaticon.com/512/3046/3046121.png"],
        "Websites": ["#6cf", "https://cdn-icons-png.flaticon.com/512/565/565547.png"],
        "Emails": ["#FF9800", "https://cdn-icons-png.flaticon.com/512/561/561127.png"],
        "Phone Numbers": ["#4CAF50", "https://cdn-icons-png.flaticon.com/512/15/15874.png"]
    };

    for (const type in typeGroups) {
        let typeId = nid++;
        let [color, icon] = icons[type] || ["#6cf", "https://cdn-icons-png.flaticon.com/512/565/565547.png"];

        // Main Branch Node (Type)
        nodes.push({
            id: typeId,
            label: type,
            shape: "image",
            image: icon,
            font: { color: "#fff", size: 14 },
            title: `Category: ${type}`,
            size: 30
        });
        
        // Edge from Center to Type
        edges.push({ 
            from: 1, 
            to: typeId, 
            arrows: { to: { enabled: true, scaleFactor: 1 } }, 
            smooth: true, 
            length: 250,
            color: { color: color, opacity: 0.6 }
        });

        // Sub Branch Nodes (Results)
        typeGroups[type].forEach(result => {
            let id = nid++;
            nodes.push({
                id: id,
                label: result.title.substring(0, 15) + "...",
                shape: "circularImage",
                image: result.image || icon,
                font: { color: "#ccc", size: 10 },
                title: `<b>${result.title}</b><br>${result.link}<br>Type: ${result.type}`,
                size: 20,
                borderWidth: 2,
                color: { border: color, background: "#1e1e1e" }
            });
            
            // Edge from Type to Result
            edges.push({ 
                from: typeId, 
                to: id, 
                arrows: { to: { enabled: true, scaleFactor: 0.5 } }, 
                dashes: true, 
                smooth: { type: 'cubicBezier' }, 
                length: 150,
                color: { color: "rgba(255,255,255,0.3)" }
            });
        });
    }

    const container = document.getElementById("resultMap");
    const network = new vis.Network(container, { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) }, {
        physics: {
            enabled: true,
            barnesHut: { gravitationalConstant: -8000, centralGravity: 0.3, springLength: 200, springConstant: 0.04, damping: 0.09 },
        },
        interaction: { hover: true, zoomView: true, dragView: true, tooltipDelay: 200 }
    });

    network.on("hoverNode", function(params) {
        // Tooltip handling is built-in with 'title' property, but we can customize if needed
        // The original code used a custom tooltip div, but vis.js has built-in support which is cleaner.
        // However, to match original functionality exactly:
        /*
        const node = network.body.data.nodes.get(params.node);
        if(node.title && !node.title.includes("<br>")) { // Only for simple titles
             tooltip.innerHTML = node.title;
             tooltip.style.display = "block";
             tooltip.style.left = (params.event.pageX + 10) + "px";
             tooltip.style.top  = (params.event.pageY + 10) + "px";
        }
        */
    });
    // network.on("blurNode", () => tooltip.style.display = "none");
}
</script>
{% endblock %}